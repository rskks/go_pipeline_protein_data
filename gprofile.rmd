```{r}
# ----------------------------
# 2. Clean accession/entry names
# ----------------------------
protein_data_clean <- protein_data_normalized %>%
  mutate(
    # Remove any " (+1)" or similar scaffold suffix
    AccessionClean = str_remove(`Accession Number`, "\\s*\\(\\+.*\\)"),

    # Extract UniProtID if present (middle piece)
    UniProtID = str_extract(AccessionClean, "(?<=\\|)[A-Z0-9]+(?=\\|)"),

    # Extract entry name (right-hand piece)
    EntryName = str_extract(AccessionClean, "[A-Z0-9_]+(?=\\|?$)"),

    # Use UniProtID if available, else entry name
    QueryID = if_else(!is.na(UniProtID), UniProtID, EntryName),

    # Extract species from entry name suffix (e.g., _HUMAN, _BOVIN)
    Species = str_extract(QueryID, "_[A-Z]+$") %>% str_remove("^_"),

    # Create Gene symbol for human/mouse/bovine (strip species suffix)
    GeneSymbol = str_remove(QueryID, "_[A-Z]+$")
  )

# ----------------------------
# 3. Split by species
# ----------------------------
species_list <- unique(protein_data_clean$Species)
cat("Species detected:\n")
print(species_list)

# Prepare list to store results
go_results_list <- list()

# ----------------------------
# 4. Fetch GO annotations per species
# ----------------------------
for (sp in species_list) {
  
  # Map gprofiler organism code
  organism_code <- case_when(
    sp == "HUMAN" ~ "hsapiens",
    sp == "BOVIN" ~ "btaurus",
    sp == "MOUSE" ~ "mmusculus",
    TRUE ~ NA_character_
  )
  
  # Skip unknown species
  if (is.na(organism_code)) next
  
  # Get gene symbols for this species
  genes_sp <- protein_data_clean %>%
    filter(Species == sp) %>%
    pull(GeneSymbol) %>%
    unique()
  
  # Fetch GO annotations
  gost_sp <- gost(
    query = genes_sp,
    organism = organism_code,
    sources = c("GO:BP", "GO:MF", "GO:CC")
  )
  
  # Store only the result table with the species column
  if (!is.null(gost_sp$result)) {
    go_results_list[[sp]] <- gost_sp$result %>%
      mutate(Species = sp)
  }
}

# ----------------------------
# 5. Combine all species results
# ----------------------------
go_results_combined <- bind_rows(go_results_list)

# ----------------------------
# 6. Merge back with protein expression data
# ----------------------------
df_with_go <- protein_data_clean %>%
  left_join(go_results_combined %>%
              select(query, term_id, term_name, source, Species),
            by = c("GeneSymbol" = "query", "Species" = "Species"))
```

```{r}
# ----------------------------
# 7. Example: Prompt user for a GO term to filter
# ----------------------------
term <- readline(prompt = "Enter GO term ID (e.g., GO:0003723): ")

filtered_df <- df_with_go %>%
  filter(term_id == term)

cat("Filtered proteins matching GO term", term, ":\n")
print(filtered_df)
```